<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>List columns</title>

<script src="site_libs/header-attrs-2.5.3/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="site_libs/anchor-sections-1.0.1/anchor-sections.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">BioMarin R meetup tutorials</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Lessons and examples</a>
</li>
<li>
  <a href="more-resources.html">More resources</a>
</li>
<li>
  <a href="slides.html">Slides</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="about.html">About</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">List columns</h1>

</div>


<p>Data frames are a fantastic data structure for data analysis. We usually think of them as a data receptacle for several atomic vectors with a common length and with a notion of “observation”, i.e. the i-th value of each atomic vector is related to all the other i-th values.</p>
<p>But data frame are not limited to atomic vectors. They can host general vectors, i.e. <em>lists</em> as well. This is what I call a <strong>list-column</strong>.</p>
<p>List-columns and the data frame that hosts them require some special handling. In particular, it is highly advantageous if the data frame is a <a href="https://github.com/tidyverse/tibble#readme">tibble</a>, which anticipates list-columns. To work comfortably with list-columns, you need to develop techniques to:</p>
<ul>
<li><strong>Inspect</strong>. What have I created?</li>
<li><strong>Index</strong>. How do I pull out specific bits by name or position?</li>
<li><strong>Compute</strong>. How do I operate on my list-column to make another vector or list-column?</li>
<li><strong>Simplify</strong>. How do I get rid of this list-column and back to a normal data frame?</li>
</ul>
<p>The purrr package and all the techniques depicted in the other lessons come into heavy play here. This is a collection of worked examples that show these techniques applied specifically to list-columns.</p>
<div id="regex-and-trump-tweets" class="section level2">
<h2>Regex and Trump tweets</h2>
<div id="load-packages" class="section level3">
<h3>Load packages</h3>
<pre class="r"><code>library(tidyverse)
library(lubridate)
library(here)</code></pre>
</div>
<div id="bring-tweets-in" class="section level3">
<h3>Bring tweets in</h3>
<p>Working with the same 7 tweets as <a href="ls08_trump-tweets.html">Trump Android words</a> lesson. Go there for the rationale for choosing these 7 tweets.</p>
<pre class="r"><code>tb_raw &lt;- read_csv(here(&quot;talks&quot;, &quot;trump-tweets.csv&quot;))
#&gt; 
#&gt; ── Column specification ────────────────────────────────────────────────────────
#&gt; cols(
#&gt;   tweet = col_character(),
#&gt;   source = col_character(),
#&gt;   created = col_datetime(format = &quot;&quot;)
#&gt; )</code></pre>
</div>
<div id="create-a-list-column-of-trump-android-words" class="section level3">
<h3>Create a list-column of Trump Android words</h3>
<p>Clean a variable and create a list-column:</p>
<ul>
<li><code>source</code> comes in an unfriendly form. Simplify to convey if tweet came from Android or iPhone.</li>
<li><code>twords</code> are what we’ll call the “Trump Android words”. See <a href="ls08_trump-tweets.html">Trump Android words</a> lesson for backstory. <strong>This is a list-column!</strong></li>
</ul>
<pre class="r"><code>source_regex &lt;- &quot;android|iphone&quot;
tword_regex &lt;- &quot;badly|crazy|weak|spent|strong|dumb|joke|guns|funny|dead&quot;

tb &lt;- tb_raw %&gt;%
  mutate(source = str_extract(source, source_regex),
         twords = str_extract_all(tweet, tword_regex))</code></pre>
</div>
<div id="derive-new-variables" class="section level3">
<h3>Derive new variables</h3>
<p>Add variables, two of which are based on the <code>twords</code> list-column.</p>
<ul>
<li><code>n</code>: How many twords are in the tweet?</li>
<li><code>hour</code>: At which hour of the day was the tweet?</li>
<li><code>start</code>: Start character of each tword.</li>
</ul>
<pre class="r"><code>tb &lt;- tb %&gt;%
  mutate(n = lengths(twords),
         hour = hour(created),
         start = gregexpr(tword_regex, tweet))</code></pre>
</div>
<div id="use-regular-data-manipulation-toolkit" class="section level3">
<h3>Use regular data manipulation toolkit</h3>
<p>Let’s isolate tweets created before 2pm, containing 1 or 2 twords, in which there’s an tword that starts within the first 30 characters.</p>
<pre class="r"><code>tb %&gt;%
  filter(hour &lt; 14,
         between(n, 1, 2),
         between(map_int(start, min), 0, 30))
#&gt; # A tibble: 1 x 7
#&gt;   tweet                    source  created             twords     n  hour start 
#&gt;   &lt;chr&gt;                    &lt;chr&gt;   &lt;dttm&gt;              &lt;list&gt; &lt;int&gt; &lt;int&gt; &lt;list&gt;
#&gt; 1 Bernie Sanders started … android 2016-07-24 11:25:06 &lt;chr …     2    11 &lt;int …</code></pre>
<p>Let’s isolate tweets that contain both the twords “strong” and “weak”.</p>
<pre class="r"><code>tb %&gt;%
  filter(map_lgl(twords, ~ all(c(&quot;strong&quot;, &quot;weak&quot;) %in% .x)))
#&gt; # A tibble: 2 x 7
#&gt;   tweet                    source  created             twords     n  hour start 
#&gt;   &lt;chr&gt;                    &lt;chr&gt;   &lt;dttm&gt;              &lt;list&gt; &lt;int&gt; &lt;int&gt; &lt;list&gt;
#&gt; 1 Bernie Sanders started … android 2016-07-24 11:25:06 &lt;chr …     2    11 &lt;int …
#&gt; 2 Crooked Hillary Clinton… android 2016-07-06 04:36:31 &lt;chr …     2     4 &lt;int …</code></pre>
</div>
</div>
<div id="json-from-an-api-and-game-of-thrones" class="section level2">
<h2>JSON from an API and Game of Thrones</h2>
<div id="load-packages-1" class="section level3">
<h3>Load packages</h3>
<pre class="r"><code>library(repurrrsive)
library(tidyverse)
library(httr)
library(here)</code></pre>
</div>
<div id="call-the-api-of-ice-and-fire" class="section level3">
<h3>Call the API of Ice and Fire</h3>
<p>Here’s a simplified version of how we obtained the data on the Game of Thrones POV characters. This data appears as a more processed list in the <a href="https://cran.r-project.org/package=repurrrsive">repurrrsive</a> package.</p>
<ul>
<li>Get character IDs from repurrrsive. <em>cheating a little, humor me</em></li>
<li>Put IDs and character names in a tibble.</li>
</ul>
<pre class="r"><code>pov &lt;- set_names(map_int(got_chars, &quot;id&quot;),
                 map_chr(got_chars, &quot;name&quot;))
tail(pov, 5)
#&gt;      Melisandre    Merrett Frey Quentyn Martell   Samwell Tarly     Sansa Stark 
#&gt;             743             751             844             954             957
ice &lt;- pov %&gt;%
  enframe(value = &quot;id&quot;)
ice
#&gt; # A tibble: 30 x 2
#&gt;    name                  id
#&gt;    &lt;chr&gt;              &lt;int&gt;
#&gt;  1 Theon Greyjoy       1022
#&gt;  2 Tyrion Lannister    1052
#&gt;  3 Victarion Greyjoy   1074
#&gt;  4 Will                1109
#&gt;  5 Areo Hotah          1166
#&gt;  6 Chett               1267
#&gt;  7 Cressen             1295
#&gt;  8 Arianne Martell      130
#&gt;  9 Daenerys Targaryen  1303
#&gt; 10 Davos Seaworth      1319
#&gt; # … with 20 more rows</code></pre>
<p>Request info for each character and store what comes back – whatever that may be – in the list-column <code>stuff</code>.</p>
<pre class="r"><code>ice_and_fire_url &lt;- &quot;https://anapioficeandfire.com/&quot;
if (file.exists(here(&quot;talks&quot;, &quot;ice.rds&quot;))) {
  ice &lt;- readRDS(here(&quot;talks&quot;, &quot;ice.rds&quot;))
} else {
  ice &lt;- ice %&gt;%
    mutate(
      response = map(id,
                     ~ GET(ice_and_fire_url,
                           path = c(&quot;api&quot;, &quot;characters&quot;, .x))),
      stuff = map(response, ~ content(.x, as = &quot;parsed&quot;,
                                      simplifyVector = TRUE))
    ) %&gt;%
    select(-id, -response)
  saveRDS(ice, here(&quot;talks&quot;, &quot;ice.rds&quot;))
}
ice
#&gt; # A tibble: 29 x 2
#&gt;    name               stuff            
#&gt;    &lt;chr&gt;              &lt;list&gt;           
#&gt;  1 Theon Greyjoy      &lt;named list [16]&gt;
#&gt;  2 Tyrion Lannister   &lt;named list [16]&gt;
#&gt;  3 Victarion Greyjoy  &lt;named list [16]&gt;
#&gt;  4 Will               &lt;named list [16]&gt;
#&gt;  5 Areo Hotah         &lt;named list [16]&gt;
#&gt;  6 Chett              &lt;named list [16]&gt;
#&gt;  7 Cressen            &lt;named list [16]&gt;
#&gt;  8 Arianne Martell    &lt;named list [16]&gt;
#&gt;  9 Daenerys Targaryen &lt;named list [16]&gt;
#&gt; 10 Davos Seaworth     &lt;named list [16]&gt;
#&gt; # … with 19 more rows</code></pre>
<p>Let’s switch to a nicer version of <code>ice</code>, based on the list in repurrrsive, because it already has books and houses replaced with names instead of URLs.</p>
<pre class="r"><code>ice2 &lt;- tibble(
  name = map_chr(got_chars, &quot;name&quot;),
  stuff = got_chars
)
ice2
#&gt; # A tibble: 30 x 2
#&gt;    name               stuff            
#&gt;    &lt;chr&gt;              &lt;list&gt;           
#&gt;  1 Theon Greyjoy      &lt;named list [18]&gt;
#&gt;  2 Tyrion Lannister   &lt;named list [18]&gt;
#&gt;  3 Victarion Greyjoy  &lt;named list [18]&gt;
#&gt;  4 Will               &lt;named list [18]&gt;
#&gt;  5 Areo Hotah         &lt;named list [18]&gt;
#&gt;  6 Chett              &lt;named list [18]&gt;
#&gt;  7 Cressen            &lt;named list [18]&gt;
#&gt;  8 Arianne Martell    &lt;named list [18]&gt;
#&gt;  9 Daenerys Targaryen &lt;named list [18]&gt;
#&gt; 10 Davos Seaworth     &lt;named list [18]&gt;
#&gt; # … with 20 more rows</code></pre>
<p>Inspect the list-column.</p>
<pre class="r"><code>str(ice2$stuff[[9]], max.level = 1)
#&gt; List of 18
#&gt;  $ url        : chr &quot;https://www.anapioficeandfire.com/api/characters/1303&quot;
#&gt;  $ id         : int 1303
#&gt;  $ name       : chr &quot;Daenerys Targaryen&quot;
#&gt;  $ gender     : chr &quot;Female&quot;
#&gt;  $ culture    : chr &quot;Valyrian&quot;
#&gt;  $ born       : chr &quot;In 284 AC, at Dragonstone&quot;
#&gt;  $ died       : chr &quot;&quot;
#&gt;  $ alive      : logi TRUE
#&gt;  $ titles     : chr [1:5] &quot;Queen of the Andals and the Rhoynar and the First Men, Lord of the Seven Kingdoms&quot; &quot;Khaleesi of the Great Grass Sea&quot; &quot;Breaker of Shackles/Chains&quot; &quot;Queen of Meereen&quot; ...
#&gt;  $ aliases    : chr [1:11] &quot;Dany&quot; &quot;Daenerys Stormborn&quot; &quot;The Unburnt&quot; &quot;Mother of Dragons&quot; ...
#&gt;  $ father     : chr &quot;&quot;
#&gt;  $ mother     : chr &quot;&quot;
#&gt;  $ spouse     : chr &quot;https://www.anapioficeandfire.com/api/characters/1346&quot;
#&gt;  $ allegiances: chr &quot;House Targaryen of King&#39;s Landing&quot;
#&gt;  $ books      : chr &quot;A Feast for Crows&quot;
#&gt;  $ povBooks   : chr [1:4] &quot;A Game of Thrones&quot; &quot;A Clash of Kings&quot; &quot;A Storm of Swords&quot; &quot;A Dance with Dragons&quot;
#&gt;  $ tvSeries   : chr [1:6] &quot;Season 1&quot; &quot;Season 2&quot; &quot;Season 3&quot; &quot;Season 4&quot; ...
#&gt;  $ playedBy   : chr &quot;Emilia Clarke&quot;
# if (interactive()) {
#   listviewer::jsonedit(ice2$stuff[[2]], mode = &quot;view&quot;, width = 500, height = 530)
# }</code></pre>
</div>
<div id="use-regular-data-manipulation-toolkit-1" class="section level3">
<h3>Use regular data manipulation toolkit</h3>
<p>Form a sentence of the form “NAME was born AT THIS TIME, IN THIS PLACE” by digging info out of the <code>stuff</code> list-column and placing into a string template. No list-columns left!</p>
<pre class="r"><code>template &lt;- &quot;${name} was born ${born}.&quot;
birth_announcements &lt;- ice2 %&gt;%
  mutate(birth = map_chr(stuff, str_interp, string = template)) %&gt;%
  select(-stuff)
birth_announcements
#&gt; # A tibble: 30 x 2
#&gt;    name               birth                                                     
#&gt;    &lt;chr&gt;              &lt;chr&gt;                                                     
#&gt;  1 Theon Greyjoy      Theon Greyjoy was born In 278 AC or 279 AC, at Pyke.      
#&gt;  2 Tyrion Lannister   Tyrion Lannister was born In 273 AC, at Casterly Rock.    
#&gt;  3 Victarion Greyjoy  Victarion Greyjoy was born In 268 AC or before, at Pyke.  
#&gt;  4 Will               Will was born .                                           
#&gt;  5 Areo Hotah         Areo Hotah was born In 257 AC or before, at Norvos.       
#&gt;  6 Chett              Chett was born At Hag&#39;s Mire.                             
#&gt;  7 Cressen            Cressen was born In 219 AC or 220 AC.                     
#&gt;  8 Arianne Martell    Arianne Martell was born In 276 AC, at Sunspear.          
#&gt;  9 Daenerys Targaryen Daenerys Targaryen was born In 284 AC, at Dragonstone.    
#&gt; 10 Davos Seaworth     Davos Seaworth was born In 260 AC or before, at King&#39;s La…
#&gt; # … with 20 more rows</code></pre>
<p>Extract each character’s house allegiances. Keep only those with more than one allegiance. Then unnest to explode the <code>houses</code> list-column and get a tibble with one row per character * house combination. No list-columns left!</p>
<pre class="r"><code>allegiances &lt;- ice2 %&gt;%
  transmute(name,
            houses = map(stuff, &quot;allegiances&quot;)) %&gt;%
  filter(lengths(houses) &gt; 1) %&gt;%
  unnest(houses)
allegiances
#&gt; # A tibble: 15 x 2
#&gt;    name             houses                             
#&gt;    &lt;chr&gt;            &lt;chr&gt;                              
#&gt;  1 Davos Seaworth   House Baratheon of Dragonstone     
#&gt;  2 Davos Seaworth   House Seaworth of Cape Wrath       
#&gt;  3 Asha Greyjoy     House Greyjoy of Pyke              
#&gt;  4 Asha Greyjoy     House Ironmaker                    
#&gt;  5 Barristan Selmy  House Selmy of Harvest Hall        
#&gt;  6 Barristan Selmy  House Targaryen of King&#39;s Landing  
#&gt;  7 Brienne of Tarth House Baratheon of Storm&#39;s End     
#&gt;  8 Brienne of Tarth House Stark of Winterfell          
#&gt;  9 Brienne of Tarth House Tarth of Evenfall Hall       
#&gt; 10 Catelyn Stark    House Stark of Winterfell          
#&gt; 11 Catelyn Stark    House Tully of Riverrun            
#&gt; 12 Jon Connington   House Connington of Griffin&#39;s Roost
#&gt; 13 Jon Connington   House Targaryen of King&#39;s Landing  
#&gt; 14 Sansa Stark      House Baelish of Harrenhal         
#&gt; 15 Sansa Stark      House Stark of Winterfell</code></pre>
</div>
</div>
<div id="aliases-and-allegiances-of-game-of-thrones-characters" class="section level2">
<h2>Aliases and allegiances of Game of Thrones characters</h2>
<div id="load-packages-2" class="section level3">
<h3>Load packages</h3>
<pre class="r"><code>library(tidyverse)
library(repurrrsive)</code></pre>
</div>
</div>
<div id="lists-as-variables-in-a-data-frame" class="section level2">
<h2>Lists as variables in a data frame</h2>
<p>One row per GoT character. List columns for aliases and allegiances.</p>
<pre class="r"><code>x &lt;- tibble(
  name = got_chars %&gt;% map_chr(&quot;name&quot;),
  aliases = got_chars %&gt;% map(&quot;aliases&quot;),
  allegiances = got_chars %&gt;% map(&quot;allegiances&quot;)
)
x
#&gt; # A tibble: 30 x 3
#&gt;    name               aliases    allegiances
#&gt;    &lt;chr&gt;              &lt;list&gt;     &lt;list&gt;     
#&gt;  1 Theon Greyjoy      &lt;chr [4]&gt;  &lt;chr [1]&gt;  
#&gt;  2 Tyrion Lannister   &lt;chr [11]&gt; &lt;chr [1]&gt;  
#&gt;  3 Victarion Greyjoy  &lt;chr [1]&gt;  &lt;chr [1]&gt;  
#&gt;  4 Will               &lt;chr [1]&gt;  &lt;NULL&gt;     
#&gt;  5 Areo Hotah         &lt;chr [1]&gt;  &lt;chr [1]&gt;  
#&gt;  6 Chett              &lt;chr [1]&gt;  &lt;NULL&gt;     
#&gt;  7 Cressen            &lt;chr [1]&gt;  &lt;NULL&gt;     
#&gt;  8 Arianne Martell    &lt;chr [1]&gt;  &lt;chr [1]&gt;  
#&gt;  9 Daenerys Targaryen &lt;chr [11]&gt; &lt;chr [1]&gt;  
#&gt; 10 Davos Seaworth     &lt;chr [5]&gt;  &lt;chr [2]&gt;  
#&gt; # … with 20 more rows
#View(x)</code></pre>
<p>What if we only care about characters with a “Lannister” alliance? Practice operating on a list-column.</p>
<pre class="r"><code>x %&gt;%
  mutate(lannister = map(allegiances, str_detect, pattern = &quot;Lannister&quot;),
         lannister = map_lgl(lannister, any))
#&gt; # A tibble: 30 x 4
#&gt;    name               aliases    allegiances lannister
#&gt;    &lt;chr&gt;              &lt;list&gt;     &lt;list&gt;      &lt;lgl&gt;    
#&gt;  1 Theon Greyjoy      &lt;chr [4]&gt;  &lt;chr [1]&gt;   FALSE    
#&gt;  2 Tyrion Lannister   &lt;chr [11]&gt; &lt;chr [1]&gt;   TRUE     
#&gt;  3 Victarion Greyjoy  &lt;chr [1]&gt;  &lt;chr [1]&gt;   FALSE    
#&gt;  4 Will               &lt;chr [1]&gt;  &lt;NULL&gt;      FALSE    
#&gt;  5 Areo Hotah         &lt;chr [1]&gt;  &lt;chr [1]&gt;   FALSE    
#&gt;  6 Chett              &lt;chr [1]&gt;  &lt;NULL&gt;      FALSE    
#&gt;  7 Cressen            &lt;chr [1]&gt;  &lt;NULL&gt;      FALSE    
#&gt;  8 Arianne Martell    &lt;chr [1]&gt;  &lt;chr [1]&gt;   FALSE    
#&gt;  9 Daenerys Targaryen &lt;chr [11]&gt; &lt;chr [1]&gt;   FALSE    
#&gt; 10 Davos Seaworth     &lt;chr [5]&gt;  &lt;chr [2]&gt;   FALSE    
#&gt; # … with 20 more rows</code></pre>
<p>Keep only the Lannisters and Starks allegiances. You can use <code>filter()</code> with list-columns, but you will need to <code>map()</code> to list-ize your operation. Once I’ve got the characters I want, I drop <code>allegiances</code> and use <code>unnest()</code> to get back to a simple data frame with no list columns.</p>
<pre class="r"><code>x %&gt;%
  filter(allegiances %&gt;%
           map(str_detect, &quot;Lannister|Stark&quot;) %&gt;%
           map_lgl(any)) %&gt;%
  select(-allegiances) %&gt;%
  filter(lengths(aliases) &gt; 0) %&gt;%
  unnest(aliases) %&gt;% 
  print(n = Inf)
#&gt; # A tibble: 57 x 2
#&gt;    name             aliases                                        
#&gt;    &lt;chr&gt;            &lt;chr&gt;                                          
#&gt;  1 Tyrion Lannister &quot;The Imp&quot;                                      
#&gt;  2 Tyrion Lannister &quot;Halfman&quot;                                      
#&gt;  3 Tyrion Lannister &quot;The boyman&quot;                                   
#&gt;  4 Tyrion Lannister &quot;Giant of Lannister&quot;                           
#&gt;  5 Tyrion Lannister &quot;Lord Tywin&#39;s Doom&quot;                            
#&gt;  6 Tyrion Lannister &quot;Lord Tywin&#39;s Bane&quot;                            
#&gt;  7 Tyrion Lannister &quot;Yollo&quot;                                        
#&gt;  8 Tyrion Lannister &quot;Hugor Hill&quot;                                   
#&gt;  9 Tyrion Lannister &quot;No-Nose&quot;                                      
#&gt; 10 Tyrion Lannister &quot;Freak&quot;                                        
#&gt; 11 Tyrion Lannister &quot;Dwarf&quot;                                        
#&gt; 12 Arya Stark       &quot;Arya Horseface&quot;                               
#&gt; 13 Arya Stark       &quot;Arya Underfoot&quot;                               
#&gt; 14 Arya Stark       &quot;Arry&quot;                                         
#&gt; 15 Arya Stark       &quot;Lumpyface&quot;                                    
#&gt; 16 Arya Stark       &quot;Lumpyhead&quot;                                    
#&gt; 17 Arya Stark       &quot;Stickboy&quot;                                     
#&gt; 18 Arya Stark       &quot;Weasel&quot;                                       
#&gt; 19 Arya Stark       &quot;Nymeria&quot;                                      
#&gt; 20 Arya Stark       &quot;Squan&quot;                                        
#&gt; 21 Arya Stark       &quot;Saltb&quot;                                        
#&gt; 22 Arya Stark       &quot;Cat of the Canaly&quot;                            
#&gt; 23 Arya Stark       &quot;Bets&quot;                                         
#&gt; 24 Arya Stark       &quot;The Blind Girh&quot;                               
#&gt; 25 Arya Stark       &quot;The Ugly Little Girl&quot;                         
#&gt; 26 Arya Stark       &quot;Mercedenl&quot;                                    
#&gt; 27 Arya Stark       &quot;Mercye&quot;                                       
#&gt; 28 Brandon Stark    &quot;Bran&quot;                                         
#&gt; 29 Brandon Stark    &quot;Bran the Broken&quot;                              
#&gt; 30 Brandon Stark    &quot;The Winged Wolf&quot;                              
#&gt; 31 Brienne of Tarth &quot;The Maid of Tarth&quot;                            
#&gt; 32 Brienne of Tarth &quot;Brienne the Beauty&quot;                           
#&gt; 33 Brienne of Tarth &quot;Brienne the Blue&quot;                             
#&gt; 34 Catelyn Stark    &quot;Catelyn Tully&quot;                                
#&gt; 35 Catelyn Stark    &quot;Lady Stoneheart&quot;                              
#&gt; 36 Catelyn Stark    &quot;The Silent Sistet&quot;                            
#&gt; 37 Catelyn Stark    &quot;Mother Mercilesr&quot;                             
#&gt; 38 Catelyn Stark    &quot;The Hangwomans&quot;                               
#&gt; 39 Eddard Stark     &quot;Ned&quot;                                          
#&gt; 40 Eddard Stark     &quot;The Ned&quot;                                      
#&gt; 41 Eddard Stark     &quot;The Quiet Wolf&quot;                               
#&gt; 42 Jaime Lannister  &quot;The Kingslayer&quot;                               
#&gt; 43 Jaime Lannister  &quot;The Lion of Lannister&quot;                        
#&gt; 44 Jaime Lannister  &quot;The Young Lion&quot;                               
#&gt; 45 Jaime Lannister  &quot;Cripple&quot;                                      
#&gt; 46 Jon Snow         &quot;Lord Snow&quot;                                    
#&gt; 47 Jon Snow         &quot;Ned Stark&#39;s Bastard&quot;                          
#&gt; 48 Jon Snow         &quot;The Snow of Winterfell&quot;                       
#&gt; 49 Jon Snow         &quot;The Crow-Come-Over&quot;                           
#&gt; 50 Jon Snow         &quot;The 998th Lord Commander of the Night&#39;s Watch&quot;
#&gt; 51 Jon Snow         &quot;The Bastard of Winterfell&quot;                    
#&gt; 52 Jon Snow         &quot;The Black Bastard of the Wall&quot;                
#&gt; 53 Jon Snow         &quot;Lord Crow&quot;                                    
#&gt; 54 Kevan Lannister  &quot;&quot;                                             
#&gt; 55 Sansa Stark      &quot;Little bird&quot;                                  
#&gt; 56 Sansa Stark      &quot;Alayne Stone&quot;                                 
#&gt; 57 Sansa Stark      &quot;Jonquil&quot;</code></pre>
</div>
<div id="nested-data-frame-modelling-and-gapminder" class="section level2">
<h2>Nested data frame, modelling, and Gapminder</h2>
<p>Another version of this same example is here:</p>
<p><a href="http://r4ds.had.co.nz/many-models.html" class="uri">http://r4ds.had.co.nz/many-models.html</a></p>
<p><em>mostly code at this point, more words needed</em></p>
<div id="load-packages-3" class="section level3">
<h3>Load packages</h3>
<pre class="r"><code>library(tidyverse)
library(gapminder)
library(broom)</code></pre>
</div>
<div id="hello-again-gapminder" class="section level3">
<h3>Hello, again, Gapminder</h3>
<pre class="r"><code>gapminder %&gt;% 
  ggplot(aes(year, lifeExp, group = country)) +
    geom_line(alpha = 1/3)</code></pre>
<p><img src="ls13_list-columns_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<p>What if we fit a line to each country?</p>
<pre class="r"><code>gapminder %&gt;%
  ggplot(aes(year, lifeExp, group = country)) +
  geom_line(stat = &quot;smooth&quot;, method = &quot;lm&quot;,
            alpha = 1/3, se = FALSE, colour = &quot;black&quot;)
#&gt; `geom_smooth()` using formula &#39;y ~ x&#39;</code></pre>
<p><img src="ls13_list-columns_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<p>What if you actually want those fits? To access estimates, p-values, etc. In that case, you need to fit them yourself. How to do that?</p>
<ul>
<li>Put the variables needed for country-specific models into nested dataframe. In a <strong>list-column</strong>!</li>
<li>Use the usual “map inside mutate”, possibly with the broom package, to pull interesting information out of the 142 fitted linear models.</li>
</ul>
</div>
<div id="nested-data-frame" class="section level3">
<h3>Nested data frame</h3>
<p>Nest the data frames, i.e. get one meta-row per country:</p>
<pre class="r"><code>gap_nested &lt;- gapminder %&gt;%
  group_by(country) %&gt;%
  nest()
gap_nested
#&gt; # A tibble: 142 x 2
#&gt; # Groups:   country [142]
#&gt;    country     data             
#&gt;    &lt;fct&gt;       &lt;list&gt;           
#&gt;  1 Afghanistan &lt;tibble [12 × 5]&gt;
#&gt;  2 Albania     &lt;tibble [12 × 5]&gt;
#&gt;  3 Algeria     &lt;tibble [12 × 5]&gt;
#&gt;  4 Angola      &lt;tibble [12 × 5]&gt;
#&gt;  5 Argentina   &lt;tibble [12 × 5]&gt;
#&gt;  6 Australia   &lt;tibble [12 × 5]&gt;
#&gt;  7 Austria     &lt;tibble [12 × 5]&gt;
#&gt;  8 Bahrain     &lt;tibble [12 × 5]&gt;
#&gt;  9 Bangladesh  &lt;tibble [12 × 5]&gt;
#&gt; 10 Belgium     &lt;tibble [12 × 5]&gt;
#&gt; # … with 132 more rows
gap_nested$data[[1]]
#&gt; # A tibble: 12 x 5
#&gt;    continent  year lifeExp      pop gdpPercap
#&gt;    &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
#&gt;  1 Asia       1952    28.8  8425333      779.
#&gt;  2 Asia       1957    30.3  9240934      821.
#&gt;  3 Asia       1962    32.0 10267083      853.
#&gt;  4 Asia       1967    34.0 11537966      836.
#&gt;  5 Asia       1972    36.1 13079460      740.
#&gt;  6 Asia       1977    38.4 14880372      786.
#&gt;  7 Asia       1982    39.9 12881816      978.
#&gt;  8 Asia       1987    40.8 13867957      852.
#&gt;  9 Asia       1992    41.7 16317921      649.
#&gt; 10 Asia       1997    41.8 22227415      635.
#&gt; 11 Asia       2002    42.1 25268405      727.
#&gt; 12 Asia       2007    43.8 31889923      975.</code></pre>
<p><em>Compare/contrast to a data frame grouped by country (dplyr-style) or split on country (base)</em>.</p>
</div>
<div id="fit-models-extract-results" class="section level3">
<h3>Fit models, extract results</h3>
<p>Fit a model for each country.</p>
<pre class="r"><code>gap_fits &lt;- gap_nested %&gt;%
  mutate(fit = map(data, ~ lm(lifeExp ~ year, data = .x)))</code></pre>
<p>Look at one fitted model, for concreteness.</p>
<pre class="r"><code>gap_fits %&gt;% tail(3)
#&gt; # A tibble: 3 x 3
#&gt; # Groups:   country [3]
#&gt;   country     data              fit   
#&gt;   &lt;fct&gt;       &lt;list&gt;            &lt;list&gt;
#&gt; 1 Yemen, Rep. &lt;tibble [12 × 5]&gt; &lt;lm&gt;  
#&gt; 2 Zambia      &lt;tibble [12 × 5]&gt; &lt;lm&gt;  
#&gt; 3 Zimbabwe    &lt;tibble [12 × 5]&gt; &lt;lm&gt;
canada &lt;- which(gap_fits$country == &quot;Canada&quot;)
summary(gap_fits$fit[[canada]])
#&gt; 
#&gt; Call:
#&gt; lm(formula = lifeExp ~ year, data = .x)
#&gt; 
#&gt; Residuals:
#&gt;     Min      1Q  Median      3Q     Max 
#&gt; -0.3812 -0.1368 -0.0471  0.2481  0.3157 
#&gt; 
#&gt; Coefficients:
#&gt;               Estimate Std. Error t value Pr(&gt;|t|)    
#&gt; (Intercept) -3.583e+02  8.252e+00  -43.42 1.01e-12 ***
#&gt; year         2.189e-01  4.169e-03   52.50 1.52e-13 ***
#&gt; ---
#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
#&gt; 
#&gt; Residual standard error: 0.2492 on 10 degrees of freedom
#&gt; Multiple R-squared:  0.9964, Adjusted R-squared:  0.996 
#&gt; F-statistic:  2757 on 1 and 10 DF,  p-value: 1.521e-13</code></pre>
<p>Let’s get all the r-squared values!</p>
<pre class="r"><code>gap_fits %&gt;%
  mutate(rsq = map_dbl(fit, ~ summary(.x)[[&quot;r.squared&quot;]])) %&gt;%
  arrange(rsq)
#&gt; # A tibble: 142 x 4
#&gt; # Groups:   country [142]
#&gt;    country          data              fit       rsq
#&gt;    &lt;fct&gt;            &lt;list&gt;            &lt;list&gt;  &lt;dbl&gt;
#&gt;  1 Rwanda           &lt;tibble [12 × 5]&gt; &lt;lm&gt;   0.0172
#&gt;  2 Botswana         &lt;tibble [12 × 5]&gt; &lt;lm&gt;   0.0340
#&gt;  3 Zimbabwe         &lt;tibble [12 × 5]&gt; &lt;lm&gt;   0.0562
#&gt;  4 Zambia           &lt;tibble [12 × 5]&gt; &lt;lm&gt;   0.0598
#&gt;  5 Swaziland        &lt;tibble [12 × 5]&gt; &lt;lm&gt;   0.0682
#&gt;  6 Lesotho          &lt;tibble [12 × 5]&gt; &lt;lm&gt;   0.0849
#&gt;  7 Cote d&#39;Ivoire    &lt;tibble [12 × 5]&gt; &lt;lm&gt;   0.283 
#&gt;  8 South Africa     &lt;tibble [12 × 5]&gt; &lt;lm&gt;   0.312 
#&gt;  9 Uganda           &lt;tibble [12 × 5]&gt; &lt;lm&gt;   0.342 
#&gt; 10 Congo, Dem. Rep. &lt;tibble [12 × 5]&gt; &lt;lm&gt;   0.348 
#&gt; # … with 132 more rows</code></pre>
<p>Let’s use a function from broom to get the usual coefficient table from <code>summary.lm()</code> but in a friendlier form for downstream work.</p>
<pre class="r"><code>library(broom)
gap_fits %&gt;%
  mutate(coef = map(fit, tidy)) %&gt;%
  unnest(coef)
#&gt; # A tibble: 284 x 8
#&gt; # Groups:   country [142]
#&gt;    country    data         fit    term     estimate std.error statistic  p.value
#&gt;    &lt;fct&gt;      &lt;list&gt;       &lt;list&gt; &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
#&gt;  1 Afghanist… &lt;tibble [12… &lt;lm&gt;   (Interc… -5.08e+2  40.5        -12.5  1.93e- 7
#&gt;  2 Afghanist… &lt;tibble [12… &lt;lm&gt;   year      2.75e-1   0.0205      13.5  9.84e- 8
#&gt;  3 Albania    &lt;tibble [12… &lt;lm&gt;   (Interc… -5.94e+2  65.7         -9.05 3.94e- 6
#&gt;  4 Albania    &lt;tibble [12… &lt;lm&gt;   year      3.35e-1   0.0332      10.1  1.46e- 6
#&gt;  5 Algeria    &lt;tibble [12… &lt;lm&gt;   (Interc… -1.07e+3  43.8        -24.4  3.07e-10
#&gt;  6 Algeria    &lt;tibble [12… &lt;lm&gt;   year      5.69e-1   0.0221      25.7  1.81e-10
#&gt;  7 Angola     &lt;tibble [12… &lt;lm&gt;   (Interc… -3.77e+2  46.6         -8.08 1.08e- 5
#&gt;  8 Angola     &lt;tibble [12… &lt;lm&gt;   year      2.09e-1   0.0235       8.90 4.59e- 6
#&gt;  9 Argentina  &lt;tibble [12… &lt;lm&gt;   (Interc… -3.90e+2   9.68       -40.3  2.14e-12
#&gt; 10 Argentina  &lt;tibble [12… &lt;lm&gt;   year      2.32e-1   0.00489     47.4  4.22e-13
#&gt; # … with 274 more rows</code></pre>
</div>
</div>

<i class="fab fa-creative-commons fa-2x"></i><i class="fab fa-creative-commons-by fa-2x"></i><i class="fab fa-creative-commons-sa fa-2x"></i>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
